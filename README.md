# 配送伝票作成システム

寺崎さんからのメール（画像）を読み取り、発注書PDFを自動生成するStreamlitアプリケーションです。

## 主な機能

- 📸 **画像解析**: Gemini 2.0 Flashを使用した高精度なメール画像解析
- ✅ **自動検証**: 店舗名・品目名の正規化と数量計算の検証
- ✏️ **手動編集**: 解析結果を確認・編集可能なテーブル
- 📄 **PDF生成**: B5サイズの発注書と出荷一覧表を自動生成
- 📋 **LINE集計**: LINEに貼り付け可能な集計テキストを自動生成

## 改善内容

### 2025/01/24 - ミス削減のための改善

1. **AIプロンプトの強化**
   - 複数行にわたる注文の処理ルールを明確化
   - 店舗名リストを明示的に提供
   - 特殊な表記（「50×1」など品名省略）への対応
   - 具体的な例を複数提示

2. **ルールベース検証機能**
   - 店舗名の自動検証・修正
   - 品目名の正規化（表記ゆれの統一）
   - 数量計算の検証

3. **結果確認・編集画面**
   - 解析結果をテーブル形式で表示
   - 各項目を編集可能
   - 追加・削除が可能
   - 合計数量の自動再計算

4. **エラーハンドリング強化**
   - 明確なエラーメッセージ
   - 自動再試行機能（最大3回）

### 2025/01/24 - 動的対応とコスト最適化

5. **動的店舗・品目管理**
   - JSONファイルで店舗名・品目名を管理
   - UIで追加・削除・編集可能
   - 新しい店舗・品目が増えても対応可能

6. **自動学習機能**
   - AIが読み取った新しい店舗名・品目名を自動追加
   - 手動設定不要で運用が楽

7. **OCR + AIハイブリッド解析**
   - OCRでテキスト抽出（無料/低コスト）
   - AIはテキストを解析（画像解析よりトークン消費が少ない）
   - OCRが失敗した場合のみ画像解析にフォールバック
   - **トークン消費量を大幅に削減**

8. **メール自動読み取り**
   - IMAP対応（Gmail、Outlook等）
   - メールから画像を自動抽出
   - 送信者フィルタ機能
   - 定期チェック機能

## セットアップ

### 必要な環境

- Python 3.8以上
- Streamlit
- Google Gemini API キー

### インストール

```bash
pip install -r requirements.txt
```

### OCR設定（日本語対応）

OCR機能を使用するには、Tesseract OCRと日本語データが必要です。

**Windows:**
1. [Tesseract OCR](https://github.com/UB-Mannheim/tesseract/wiki)をインストール
2. 日本語データ（jpn.traineddata）が含まれていることを確認

**macOS:**
```bash
brew install tesseract tesseract-lang
```

**Linux:**
```bash
sudo apt-get install tesseract-ocr tesseract-ocr-jpn
```

**pytesseractのパス設定（必要に応じて）:**
```python
# app.pyの先頭に追加（Windowsの場合）
import pytesseract
pytesseract.pytesseract.tesseract_cmd = r'C:\Program Files\Tesseract-OCR\tesseract.exe'
```

### 環境変数の設定

Streamlit Cloudを使用する場合、Secretsに以下を設定：

```toml
COMPANY_NAME = "(株)アイプラス"
GEMINI_API_KEY = "your-api-key-here"
```

ローカルで実行する場合、`.streamlit/secrets.toml`を作成：

```toml
COMPANY_NAME = "(株)アイプラス"
GEMINI_API_KEY = "your-api-key-here"
```

### 実行

```bash
streamlit run app.py
```

## 使い方

### 方法1: 画像をアップロード

1. **「📸 画像解析」タブを選択**
2. **画像をアップロード**: 寺崎さんからのメール画像をアップロード
3. **AI解析を実行**: 「🔍 AI解析を実行」ボタンをクリック
   - OCRでテキスト抽出を試みます（トークン節約）
   - OCRが失敗した場合は画像解析に自動切り替え
4. **結果を確認・編集**: テーブルでデータを確認し、必要に応じて編集
5. **PDFを生成**: 「📄 PDFを生成」ボタンをクリック
6. **ダウンロード**: 生成されたPDFをダウンロード

### 方法2: メール自動読み取り

1. **「📧 メール自動読み取り」タブを選択**
2. **メール設定**: IMAPサーバー、メールアドレス、パスワードを入力
3. **メールをチェック**: 「📬 メールをチェック」ボタンをクリック
4. **画像を選択**: 取得した画像から解析したいものを選択
5. **解析実行**: 「🔍 この画像を解析」ボタンをクリック
6. **PDF生成**: 以降は方法1と同じ

### 方法3: 設定管理

1. **「⚙️ 設定管理」タブを選択**
2. **店舗名管理**: 新しい店舗名を追加・削除
3. **品目名管理**: 新しい品目名や表記ゆれを追加・削除
4. **自動学習**: 解析時に新しい店舗・品目が自動的に追加されます

## 対応している店舗・品目

### デフォルト店舗名

- 鎌ケ谷
- 五香
- 八柱
- 青葉台
- 咲が丘
- 習志野台
- 八千代台

**※設定管理画面で追加・削除可能です**

### デフォルト品目名

- 胡瓜（きゅうり、キュウリ）
- 長ネギ（ネギ、ねぎ）
- 春菊（しゅんぎく）
- 青梗菜（チンゲン菜、ちんげん菜）

**※設定管理画面で追加・削除可能です。新しい品目も自動学習されます。**

## 計算ルール

- **胡瓜(3本P)**: 30本/箱
- **胡瓜(バラ)**: 100本/箱（50本以上なら50本箱1、未満はバラ）
- **春菊**: 30袋/箱
- **青梗菜**: 20袋/箱
- **長ネギ(2本P)**: 30本/箱

## トラブルシューティング

### 解析が失敗する場合

- 画像が鮮明か確認してください
- メールの形式が標準的か確認してください
- 再試行ボタンで再度解析を試してください

### データが正しく読み取れない場合

- 結果確認画面で手動で編集できます
- 店舗名はドロップダウンから選択できます
- 数量は直接編集可能です

### PDF生成エラーが発生する場合

- 数値が正しく入力されているか確認してください
- 店舗名・品目名が空でないか確認してください

## コスト最適化

### トークン消費量の削減

1. **OCR + AIハイブリッド解析**
   - OCRでテキスト抽出（無料/低コスト）
   - AIはテキストのみを解析（画像解析より約70-80%トークン削減）
   - OCRが失敗した場合のみ画像解析にフォールバック

2. **プロンプト最適化**
   - 再試行回数を最小化
   - 動的設定によりプロンプトを最適化

3. **ルールベース検証**
   - AI呼び出しの精度向上により再試行を削減
   - 手動編集機能により、エラー時の再解析を回避

### 運用コストの削減

- 自動学習機能により、手動設定が不要
- メール自動読み取りにより、手作業を削減

## ライセンス

このプロジェクトは小島農園の所有物です。
