# メール連携ガイド

## メール自動読み取り機能の使い方

### 1. Streamlitアプリでメール連携を設定

1. **Streamlitアプリを起動**
   ```bash
   streamlit run app.py
   ```

2. **「📧 メール自動読み取り」タブを選択**

3. **メール設定を入力**
   - **IMAPサーバー**: メールプロバイダーのIMAPサーバーアドレス
   - **メールアドレス**: 受信するメールアドレス
   - **パスワード**: メールパスワードまたはアプリパスワード
   - **送信者メール（フィルタ）**: 特定の送信者のみ取得する場合（空欄で全て）
   - **何日前まで遡るか**: 過去何日分のメールをチェックするか

4. **「📬 メールをチェック」ボタンをクリック**

5. **取得した画像から解析したいものを選択**

---

## 主要メールプロバイダーの設定

### Gmail（Google）

**IMAPサーバー**: `imap.gmail.com`

**パスワード設定**:
1. Googleアカウントの設定 → セキュリティ
2. 「2段階認証プロセス」を有効化
3. 「アプリパスワード」を生成
4. 生成された16文字のパスワードを使用

**設定例**:
- IMAPサーバー: `imap.gmail.com`
- メールアドレス: `your-email@gmail.com`
- パスワード: `xxxx xxxx xxxx xxxx`（アプリパスワード）
- 送信者メール: `terasaki@example.com`（寺崎さんのメールアドレス）

---

### Outlook / Microsoft 365

**IMAPサーバー**: `outlook.office365.com` または `imap-mail.outlook.com`

**パスワード設定**:
- 通常のメールパスワードを使用
- 2段階認証が有効な場合は、アプリパスワードが必要な場合があります

**設定例**:
- IMAPサーバー: `outlook.office365.com`
- メールアドレス: `your-email@outlook.com`
- パスワード: 通常のメールパスワード

---

### Yahooメール

**IMAPサーバー**: `imap.mail.yahoo.com`

**パスワード設定**:
- Yahooアカウントのセキュリティ設定で「アプリパスワード」を生成

**設定例**:
- IMAPサーバー: `imap.mail.yahoo.com`
- メールアドレス: `your-email@yahoo.co.jp`
- パスワード: アプリパスワード

---

### その他のメールプロバイダー

一般的なIMAPサーバー設定:
- **iCloud**: `imap.mail.me.com`
- **AOL**: `imap.aol.com`
- **カスタムドメイン**: メールプロバイダーに問い合わせ

---

## セキュリティに関する注意事項

### アプリパスワードの使用を推奨

通常のメールパスワードではなく、**アプリパスワード**を使用することを強く推奨します。

**理由**:
- セキュリティが向上
- アカウント全体へのアクセス権限を制限
- 必要に応じて個別に無効化可能

### Streamlit Cloudでの使用

Streamlit Cloudで使用する場合、メール設定は**毎回入力する必要があります**（セキュリティのため、保存されません）。

**推奨方法**:
- ローカル環境で使用する
- または、Streamlit Secretsに保存（非推奨：セキュリティリスク）

---

## トラブルシューティング

### エラー: "IMAP接続エラー"

**原因**:
- IMAPサーバーアドレスが間違っている
- ポート番号の問題（通常は993でSSL接続）

**解決方法**:
- IMAPサーバーアドレスを確認
- ファイアウォール設定を確認

---

### エラー: "認証エラー"

**原因**:
- メールアドレスまたはパスワードが間違っている
- アプリパスワードが必要なのに通常のパスワードを使用している

**解決方法**:
- アプリパスワードを生成して使用
- 2段階認証が有効か確認

---

### エラー: "メールが見つからない"

**原因**:
- 「何日前まで遡るか」の設定が短すぎる
- 送信者フィルタが厳しすぎる

**解決方法**:
- 「何日前まで遡るか」を増やす（例: 7日）
- 送信者フィルタを空欄にする

---

### 画像が取得できない

**原因**:
- メールに画像が添付されていない
- 画像形式が対応していない

**解決方法**:
- メールに画像が添付されているか確認
- 対応形式: PNG, JPG, JPEG

---

## 使用例

### 例1: Gmailで寺崎さんからのメールを自動取得

1. **設定**:
   - IMAPサーバー: `imap.gmail.com`
   - メールアドレス: `your-email@gmail.com`
   - パスワード: `xxxx xxxx xxxx xxxx`（アプリパスワード）
   - 送信者メール: `terasaki@example.com`
   - 何日前まで遡るか: `1`

2. **実行**:
   - 「📬 メールをチェック」をクリック
   - 取得した画像を選択
   - 「🔍 この画像を解析」をクリック

---

## よくある質問

### Q: メール設定は保存されますか？

A: いいえ。セキュリティのため、メール設定は保存されません。毎回入力する必要があります。

### Q: 定期自動チェックはできますか？

A: 現在のバージョンでは、手動で「📬 メールをチェック」ボタンをクリックする必要があります。将来的に定期チェック機能を追加する予定です。

### Q: 複数のメールアカウントに対応していますか？

A: 現在は1つのメールアカウントのみ対応しています。複数のアカウントを使用する場合は、設定を変更して再度チェックしてください。

### Q: メールを既読にできますか？

A: 現在のバージョンでは、メールを既読にする機能は実装されていません。将来的に追加する予定です。

---

## セキュリティベストプラクティス

1. **アプリパスワードを使用**: 通常のパスワードではなく、アプリパスワードを使用
2. **定期的にパスワードを変更**: セキュリティのため、定期的にアプリパスワードを再生成
3. **不要なアクセスを削除**: 使用しないアプリパスワードは削除
4. **ローカル環境での使用を推奨**: メール設定を入力する場合は、ローカル環境での使用を推奨
